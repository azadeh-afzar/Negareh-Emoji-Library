stages:
  - test
  - release

# default settings for all ci jobs.
default:
  image: azadehafzarhub/gitlab-ci-ruby-build:ready
  cache:
    paths:
      - vendor/

# job for testing package against ruby version 2.6
# on master branch and send test coverage result to
# codeclimate.
main_test:
  stage: test
  before_script:
    # debug code
    - pwd
    - ls
    - ls /usr
    - ls /usr/local
    - ls /usr/local/rvm
    - ls /user/local/rvm/bin
    - /user/local/rvm/bin/rvm
    # install and use default ruby version 2.6.
    - rvm install 2.6
    - rvm use 2.6
    # upgrade bundler to latest version.
    - gem install bundler
    # install dependency gems.
    - bundle install --path vendor
    # run codeclimate test reporter agent.
    - cc-test-reporter before-build
  # run tests.
  script:
    - script/test.sh
  # send test coverage result to codeclimate.
  after_script:
    - cc-test-reporter after-build --coverage-input-type simplecov
  only:
    - master

# jobs for testing package against many ruby versions.
ruby_2_5_test:
  stage: test
  before_script:
    # install and use ruby version 2.5.
    - rvm install 2.5
    - rvm use 2.5
    # upgrade bundler to latest version.
    - gem install bundler
    # install dependency gems.
    - bundle install --path vendor
  # run tests.
  script:
    - script/test.sh

ruby_2_4_test:
  stage: test
  before_script:
    # install and use ruby version 2.4.
    - rvm install 2.4
    - rvm use 2.4
    # upgrade bundler to latest version.
    - gem install bundler
    # install dependency gems.
    - bundle install --path vendor
  # run tests.
  script:
    - script/test.sh

ruby_2_3_test:
  stage: test
  before_script:
    # install and use ruby version 2.3.
    - rvm install 2.3
    - rvm use 2.3
    # upgrade bundler to latest version.
    - gem install bundler
    # install dependency gems.
    - bundle install --path vendor
  # run tests.
  script:
    - script/test.sh

# job for testing package on other branches
# and merge requests against 2.6 version.
ruby_2_6_test:
  stage: test
  before_script:
    # install and use ruby version 2.3.
    - rvm install 2.3
    - rvm use 2.3
    # upgrade bundler to latest version.
    - gem install bundler
    # install dependency gems.
    - bundle install --path vendor
  # run tests.
  script:
    - script/test.sh
  only:
    - branches
    - merge_requests

# deploy gems to rubygems.org whenever a tag is released.
release_rubygems:
  stage: release
  script:
    # create rubygems credential file for auto login.
    - script/ci_rubygems.sh
    # extract tag from git log and strip "v".
    - version=$(git describe --tags)
    - version=${version:1}
    # build and push gem.
    - gem build negarmoji.gemspec
    - gem push "negarmoji-$version.gem"
  # only run for new tags.
  only:
    - tags
  when: manual